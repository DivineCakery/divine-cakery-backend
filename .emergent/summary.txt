<analysis>

original_problem_statement:
The initial task was a continuation of fixing production bugs and adding new features. The session began by addressing a critical app crash on the 'Orders' page. However, due to user frustration with recent instabilities, a hard reset of the codebase to a state from Dec 14, 2025, was performed.

Following the rollback, the user requested the implementation of several new features and bug fixes:
1.  **Product Whitelisting:** Re-implement a feature allowing admins to control which products are visible to specific customers.
2.  **Pay Later (COD):** Implement a Pay Later option for whitelisted customers with admin-configurable limits and custom order confirmation messages.
3.  **Manual Quantity Input:** Change the product quantity selector on customer-facing pages from a simple +/- button to a manual text input.
4.  **Mandatory Force Update:** Implement a blocking, admin-configurable force update mechanism to prevent users on old versions from using the app.
5.  **Delivery Date Calculation Bug:** Fix an issue where the delivery date for online payments was being calculated incorrectly based on the user's device time instead of the server's IST timezone.
6.  **Standing Orders Product List Bug:** Fix a bug where the product selection list on the admin's standing orders page was not showing all available products.
7.  **Standing Order Auto-Regeneration:** Implement a mechanism for standing orders to automatically regenerate after their 10-day cycle.
8.  **Preparation List Bug:** Fix a report that was showing the same items every day due to a timezone mismatch (UTC vs. IST).
9.  **Recurring Standing Order Items Bug:** Investigate and fix why items from standing orders are appearing on the preparation list on days they are not scheduled for delivery.

**User's preferred language**: English

**what currently exists?**
The application is a full-stack Expo/FastAPI monorepo.
-   **Backend:** The FastAPI backend is connected to a production MongoDB database and deployed on Render.com with auto-deploy from the  branch. It has been significantly updated with:
    -   Product whitelisting endpoints.
    -   Pay Later (COD) logic, including new fields on the  model and a new  collection for configuration.
    -   Admin-configurable force update logic.
    -   A fix for the delivery date calculation bug.
    -   A fix for the preparation list timezone bug.
    -   An endpoint for automatically regenerating standing orders.
-   **Frontend:** The Expo codebase contains the UI for all the newly implemented features (Whitelisting Modal, Pay Later options, Manual Quantity Input, Force Update Modal, Admin Settings). However, several of these changes are **not yet available to users** as they require a new build. The last successful build was **Build 99 (v1.0.17)**.

**Last working item**:
- Last item agent was working: Investigating why items from standing orders are appearing on the preparation list on incorrect days. The agent found old, incorrectly generated order documents in the database from November that might be polluting the report. The investigation was paused while trying to understand how these old orders were being included in the current day's report.
- Status: IN PROGRESS
- Agent Testing Done: N
- Which testing method agent to use? backend testing agent
- User Testing Done: N

**All Pending/In progress Issue list**:
- Issue 1: Standing order items appear on the preparation list on non-scheduled days (P0)

Issues Detail:
- Issue 1: 
     - **Description**: The daily preparation list is including items from standing orders even on days when those orders are not scheduled for delivery (e.g., a Mon/Wed/Fri standing order item appearing on a Tuesday list).
     - **Attempted fixes**: The agent identified that old, incorrectly generated standing order documents exist in the database with incorrect delivery dates. It was in the process of debugging why the preparation list query was fetching these items.
     - **Next debug checklist**:
        1.  Examine the query in the  endpoint in .
        2.  Verify the filters being used. The query likely filters by , but it may be missing a filter for  (e.g., it should only include  orders). The old, bad orders might have a different status that causes them to be incorrectly included.
        3.  Consider creating a one-time script to clean up or delete the old, malformed standing order documents from November to prevent them from affecting future reports.
     - **Why fix this issue and what will be achieved with the fix?** This bug leads to incorrect production planning, causing waste and confusion. Fixing it will ensure the preparation list is accurate and reliable.
     - **Status**:  IN PROGRESS
     - **Is recurring issue?** N
     - **Should Test frontend/backend/both after fix?** Backend.
     - **Blocked on other issue**: None

**In progress Task List**:
- None.

**Upcoming and Future Tasks**

- **Upcoming Tasks:**
    - **P0: Create and Deliver a New Android Build:** Multiple critical frontend fixes and features are complete in the codebase but are not in the hands of users. This includes Manual Quantity Input, fixes for the Standing Orders UI (product list and regenerate button), and the admin-configurable force update UI. A new build is required to deploy these changes.
    - **P1: Re-attempt  Native SDK Integration:** The original payment window closes on minimize issue still exists because the app uses . This task was abandoned in a previous session due to build failures and should be re-attempted to improve the payment UX.

- **Future Tasks:**
    - **P2: Refactor Order Data Model:** The database  collection has inconsistent fields ( vs. ) and inconsistent  formats (some with time, some without). A migration script and code refactor would improve stability.

**Completed work in this session**
- List of all completed tasks with file and method name:
  - **Codebase Rollback**: Reverted the entire repository to a commit from Dec 14, 2025 () as per user request.
  - **Product Whitelisting Feature**:
    - Backend: Added  to  model (), added  and modified  in .
    - Frontend: Created  and integrated it into .
  - **Pay Later (COD) Feature**:
    - Backend: Added  &  to  model, created  for confirmation messages, and updated order creation logic in .
    - Frontend: Updated , , and . Added highlighting for Pay Later orders in .
  - **Manual Quantity Input Feature**: Modified the quantity counter to be a  in  and . (NEEDS NEW BUILD)
  - **Admin-Configurable Force Update**:
    - Backend: Modified  to read from a new  collection and added  endpoints in .
    - Frontend: Created , integrated it in , and added a management UI in .
  - **Delivery Date Calculation Fix**: Removed frontend date calculation and centralized it in the backend payment callback logic in  to always use IST. (FIX IS LIVE)
  - **Standing Order Product List Fix**: Modified  to call  with . (NEEDS NEW BUILD)
  - **Standing Order Auto-Regeneration**: Added a  endpoint in  for cron job execution. (BACKEND IS LIVE)
  - **Preparation List Timezone Fix**: Corrected the  query in  to use IST instead of UTC. (FIX IS LIVE)
  - **Android Build 99 (v1.0.17)**: Successfully created a new build including the whitelisting and Pay Later features.

- Recently completed:
  - Preparation List Timezone Fix (DONE - DEPLOYED)
  - Standing Order Auto-Regeneration (Backend) (DONE - DEPLOYED)
  - Standing Orders Product List Fix (DONE - IN CODE, PENDING BUILD)
  - Delivery Date Calculation Bug Fix (DONE - DEPLOYED)
  - Android Build 99 (v1.0.17) (DONE)

**Earlier issues found/mentioned but not fixed**
   - **Issue 1: EAS Build failures with native modules ()**
     - **Debug checklist**:
       - Start a fresh branch from .
       - Re-add .
       - Use an Expo config plugin to manage native file modifications instead of .
       - Check for  and dependency version compatibility between the app and the library.
     - **Why to solve this issue and what will be achieved with this?** This will solve a major UX problem where the payment window closes if the user minimizes the app, leading to failed or abandoned payments.
     - **Should Test frontend/backend/both after fix?** Frontend (via new Android build).
     - **Is recurring issue?** Y

**Known issue recurrence from previous fork**
  - **Issue recurrence in previous fork**: App crashes on 'Orders' page.
  - **Recurrence count**: This issue was the initial focus of the session. While the code was fixed, the entire codebase was then reverted at the user's request. The fix was later re-applied while debugging a different missing orders issue.
  - **Status**: RESOLVED (The null-safe fixes were re-implemented and included in Build 99).

**Code Architecture**


**Key Technical Concepts**
- **Hard Reset & Feature Re-implementation**: The session involved a HEAD is now at 1a4f997e auto-commit for 46e7dfb2-80cb-4c22-a071-bbdfe4d5ac32, wiping out recent work, followed by a careful, planned re-implementation of features.
- **Backend-Driven UI/Features**: Features like Pay Later and Force Update are controlled by flags and settings in the backend database, allowing for dynamic changes without new app builds.
- **Timezone-Sensitive Logic**: Several bugs were caused by mishandling timezones (UTC vs. IST). The fixes involved centralizing date/time logic on the backend and ensuring it consistently uses the correct timezone (IST).
- **Graceful Degradation for Old Clients**: New features like Pay Later were implemented such that older app versions without the UI would simply not see the option, preventing crashes.
- **Frontend vs. Backend Changes**: The agent had to repeatedly explain to the user which changes require a new app build (frontend UI) and which are effective immediately (backend logic deployed on Render).

**key DB schema**
- **users**: { ..., : List[str], : bool, : float }
- **orders**: { : String, : String, : String, : Datetime } - NOTE: Still contains inconsistent / fields.
- **settings**: { : String, : Dict } - New collection to store global settings like confirmation messages and app version info.

**changes in tech stack**
-  was removed from  to resolve build issues.

**All files of reference**
- : Core logic for orders, payments, prep lists, and app settings. All major backend fixes are here.
- : Contains the new auto-regeneration logic.
- : New central hub for admin-configurable settings.
- : Contains logic for the Pay Later feature.
- : Contains frontend fixes that are not yet deployed.
- : Contains frontend changes that are not yet deployed.
- : Contains the new force update logic.

**Areas that need refactoring**:
- The  collection data model is still a source of bugs due to inconsistent fields ( vs ) and date formats. A data migration and code cleanup are recommended.
- The standing order logic seems complex and has led to bad data being created. It could benefit from a review and simplification.

**key api endpoints**
- : Sets product whitelist.
- : Manages confirmation messages for orders.
- : Manages force update configuration.
- : Serves version info to the app, now reads from DB.
- : Modified to handle .
- : New endpoint for cron job to regenerate all standing orders.
- : Fixed to use correct IST timezone.

**Critical Info for New Agent**
- **Your immediate task is to fix the bug with the preparation list showing incorrect standing order items.** The root cause is likely old, malformed data being included in the query. Investigate the query in  and consider adding a status filter or a data cleanup script.
- **Multiple frontend changes are NOT yet deployed.** Features like manual quantity input and UI fixes for standing orders are in the code but require a new build to reach users. Be prepared to initiate a new build after fixing the current bug.
- **The backend is now highly configurable.** Force updates and other settings are controlled via the  collection in the database, accessible through the admin panel. Do not hardcode these values.
- **Timezones are critical.** Many previous bugs were related to UTC vs. IST mismatches. Ensure all new date-related logic on the backend correctly uses IST.

**documents created in this job**
- 
- 

**Last 10 User Messages and any pending user messages**
1.  **User:** regenerate button in standing orders doesn't work. (RESOLVED - Agent fixed the  call, but the fix needs a new build).
2.  **User:** Preparation list is not working correctly, showing same list every day. (RESOLVED - Agent fixed backend timezone logic, fix is live).
3.  **User:** Standing order items are appearing in prep list every day, regardless of schedule. (IN PROGRESS - This is the current P0 issue).
4.  **User:** Confirms agent's investigation into the standing order item issue.
5.  **User:** Asks if a new build is needed for the delivery date fix. (RESOLVED - Agent confirmed no new build needed as it was a backend fix).
6.  **User:** Reports the delivery date is not being calculated with the  logic. (RESOLVED - Agent found and fixed the frontend timezone bug).
7.  **User:** Confirms Build 99 is finished and asks if it's complete. (RESOLVED - Agent provided details of the successful build).
8.  **User:** Reports the product list in the admin standing order page is incomplete. (RESOLVED - Agent fixed the code, but the fix needs a new build).
9.  **User:** Asks if standing orders auto-regenerate after 10 occurrences. (RESOLVED - Agent confirmed it did not and implemented a backend endpoint for it).
10. **User:** Reports the regenerate button is not visible on the standing orders page. (RESOLVED - Agent added the UI, but the fix needs a new build).

**Project Health Check:**
- Broken: The Preparation List feature is currently unreliable due to the standing order bug, which impacts production. The Standing Orders admin page has a broken product filter and a non-functional regenerate button in the currently deployed version (pre-Build 99) and the web preview (until the code is fixed).
- Mocked: None.

**3rd Party Integrations**
- **Razorpay (Payments):** Requires User API Key. Integrated via Payment Links with .
- **MongoDB Atlas (Database):** Live production database.
- **Render.com (Hosting):** For the backend service, with auto-deploys from the  GitHub branch.
- **EAS (Build Service):** For building the Android app.

**Testing status**
- Testing agent used after significant changes: NO
- Troubleshoot agent used after agent stuck in loop: NO
- Test files created: []
- Known regressions: None in this session, but the payment UX remains suboptimal due to not using the native Razorpay SDK.

**Credentials to test flow:**
- Admin and customer credentials can be found by querying the production database.

**What agent forgot to execute**
- The agent implemented the backend endpoint for standing order regeneration but initially forgot to add a corresponding button in the admin UI until prompted by the user.

</analysis>
